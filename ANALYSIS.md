# تحليل المشاكل - نظام MMC-MMS

## المشكلة الرئيسية
عدم ربط الفرونت اند مع الباك اند بشكل صحيح

---

## 1. نظام البن كود (PIN System)

### المشكلة الحالية
- **الباك اند**: `/functions/api/v1/pin/status.js` يولد بن كود واحد لكل عيادة يومياً (من 10-99)
- **الفرونت اند**: `src/core/pin-engine.js` يولد 20 بن كود عشوائي (01-20) ولا يستخدم API
- **النتيجة**: أي رقم يفتح العيادة لأن التحقق غير موجود

### الحل المطلوب
1. حذف `pin-engine.js` من الفرونت اند (لا يستخدم)
2. تعديل `PatientPage.jsx` لاستخدام البن كود من API مباشرة
3. التحقق من البن كود في الباك اند قبل فتح العيادة
4. كل عيادة لها بن كود واحد فقط في اليوم

---

## 2. نظام الدور والطابور (Queue System)

### المشكلة الحالية
- الفرونت اند يدخل المريض تلقائياً بدون انتظار البن كود
- لا يوجد تحقق من البن كود قبل الدخول
- الأرقام غير دقيقة

### الحل المطلوب
1. منع الدخول التلقائي للعيادة
2. طلب البن كود أولاً
3. التحقق من البن كود عبر API
4. بعد التحقق، الدخول للطابور

---

## 3. المسارات الديناميكية (Dynamic Routing)

### المشكلة الحالية
- المسارات تُحسب في الفرونت اند فقط
- لا يتم حساب الأوزان الفعلية من الباك اند

### الحل المطلوب
1. استخدام `/api/v1/path/choose` من الباك اند
2. حساب الأوزان بناءً على الازدحام الفعلي
3. الأقل ازدحاماً أعلى أولوية

---

## 4. الإشعارات اللحظية

### المشكلة الحالية
- التوقيت غير دقيق
- التصميم يحتاج تحسين

### الحل المطلوب
1. تحسين SSE في `/api/v1/events/stream`
2. تحسين عرض الإشعارات في الفرونت اند
3. إضافة أصوات واضحة

---

## خطة العمل

### المرحلة 1: إصلاح نظام البن كود ✅
1. تعديل `PatientPage.jsx` لاستخدام API
2. إضافة التحقق من البن كود
3. منع الدخول بدون بن كود صحيح

### المرحلة 2: إصلاح نظام الدور ✅
1. ربط الدخول بالبن كود
2. تحديث الأرقام لحظياً
3. تحسين العرض

### المرحلة 3: إصلاح المسارات ✅
1. استخدام API للمسارات
2. حساب الأوزان الفعلية
3. تحديث المسار ديناميكياً

### المرحلة 4: تحسين الإشعارات ✅
1. تحسين التوقيت
2. تحسين التصميم
3. إضافة الأصوات

### المرحلة 5: الاختبار النهائي ✅
1. اختبار كل ميزة على الموقع المباشر
2. التأكد من نسبة نجاح 100%

