# ุฅุตูุงุญ ูุดููุฉ Race Condition ูู ูุธุงู ุงูุฏูุฑ (Queue System)

**ุงูุชุงุฑูุฎ:** 19 ุฃูุชูุจุฑ 2025
**ุงูุฅุตุฏุงุฑ:** v2025-10-19-queue-do

---

## ุงููุดููุฉ ุงูููุชุดูุฉ

ุชู ุงูุชุดุงู ูุดููุฉ ุญุฑุฌุฉ ูู ูุธุงู ุงูุฏูุฑ (Queue System) ุชุคุฏู ุฅูู ุชูุฑุงุฑ ุฃุฑูุงู ุงูุฏูุฑ ุนูุฏ ูุฌูุฏ ุทูุจุงุช ูุชุฒุงููุฉ ูู ุนุฏุฉ ูุฑุงุฌุนูู ูู ููุณ ุงูููุช.

### ุงูุณุจุจ ุงูุฌุฐุฑู

ุงููุดููุฉ ุชููู ูู ุงุณุชุฎุฏุงู **Cloudflare KV** ูุฅุฏุงุฑุฉ ุงูุนุฏุงุฏุงุช (Counters)ุ ุญูุซ ุฃู KV:
- ูุง ูุฏุนู ุงูุนูููุงุช ุงูุฐุฑูุฉ (Atomic Operations) ุจุดูู ุฃุตูู
- ูุนุชูุฏ ุนูู ุงูุชุฒุงูู ุงูููุงุฆู (Eventual Consistency)
- ุขููุฉ ุงูููู (Lock Mechanism) ุงููุทุจูุฉ ุณุงุจูุงู ุบูุฑ ูุนุงูุฉ ุจุณุจุจ ุงููุงูุฐุฉ ุงูุฒูููุฉ ุจูู `PUT` ู `GET`

### ุงูุฏููู

ุนูุฏ ุงุฎุชุจุงุฑ 5 ูุณุชุฎุฏููู ูุชุฒุงููููุ ุญุตู ุงุซูุงู ูููู ุนูู ููุณ ุฑูู ุงูุฏูุฑ (31):

| ุงููุณุชุฎุฏู | ุฑูู ุงูุฏูุฑ | ุงูุญุงูุฉ |
|---------|-----------|--------|
| TEST_USER_1 | 30 | โ ุตุญูุญ |
| TEST_USER_2 | 33 | โ ุตุญูุญ |
| TEST_USER_3 | **31** | โ๏ธ ููุฑุฑ |
| TEST_USER_4 | **31** | โ๏ธ ููุฑุฑ |
| TEST_USER_5 | 32 | โ ุตุญูุญ |

---

## ุงูุญู ุงููุทุจู

ุชู ุชุทุจูู ุญู ุฌุฐุฑู ุจุงุณุชุฎุฏุงู **Cloudflare Durable Objects** ุงูุฐู ูููุฑ:
- โ **ูุนุงูุฌุฉ ุชุณูุณููุฉ (Serial Processing):** ูู ุทูุจ ููุนุงูุฌ ูุงุญุฏุงู ุชูู ุงูุขุฎุฑ
- โ **ุฐุฑูุฉ ุญููููุฉ 100%:** ูุง ุชูุฌุฏ ูุงูุฐุฉ ุฒูููุฉ ููุชุถุงุฑุจ
- โ **ููุซูููุฉ ูุงููุฉ:** ุถูุงู ุนุฏู ุชูุฑุงุฑ ุงูุฃุฑูุงู ูุทููุงู
- โ **ุฃุฏุงุก ุนุงูู:** ูุตูู ุฎุตูุตุงู ูุญุงูุงุช ุงูุชุฒุงูู ุงูุนุงูู

### ุงูุชุบููุฑุงุช ุงููุทุจูุฉ

#### 1. ุฅูุดุงุก Durable Object ููู Queue Counter

**ุงูููู:** `functions/QueueCounter.js`

```javascript
export class QueueCounter {
  constructor(state, env) {
    this.state = state;
    this.storage = state.storage;
  }

  async fetch(request) {
    // ูุนุงูุฌุฉ ุชุณูุณููุฉ ุฐุฑูุฉ ููุทูุจุงุช
    // /enter - ุฅุตุฏุงุฑ ุฑูู ุฌุฏูุฏ
    // /status - ุงูุญุตูู ุนูู ุงูุญุงูุฉ ุงูุญุงููุฉ
    // /done - ุชูุฏูู ุงูุฑูู ุงูุญุงูู
    // /reset - ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏุงุช
  }
}
```

#### 2. ุชุญุฏูุซ Queue API Endpoints

ุชู ุชุญุฏูุซ ุงููููุงุช ุงูุชุงููุฉ ูุงุณุชุฎุฏุงู Durable Objects:
- `functions/api/v1/queue/enter.js` - ุฏุฎูู ุงูุฏูุฑ
- `functions/api/v1/queue/status.js` - ุญุงูุฉ ุงูุฏูุฑ
- `functions/api/v1/queue/done.js` - ุฅููุงุก ุงููุญุต

#### 3. ุฅุตูุงุญ SSE Heartbeat

**ุงูููู:** `functions/api/v1/events/stream.js`

ุชู ุฅุถุงูุฉ:
- โญ Heartbeat ูู 15 ุซุงููุฉ ูุฅุจูุงุก ุงูุงุชุตุงู ุญูุงู
- โญ ูุญุต ุงูุชุญุฏูุซุงุช ูู 5 ุซูุงู
- โญ ุฅุบูุงู ุชููุงุฆู ุจุนุฏ 5 ุฏูุงุฆู

#### 4. ุชุญุฏูุซ wrangler.toml

```toml
[durable_objects]
bindings = [
  { name = "QUEUE_DO", class_name = "QueueCounter", script_name = "mmc-mms" }
]

[[migrations]]
tag = "v2025-10-19-queue-do"
new_classes = ["QueueCounter"]
```

---

## ุขููุฉ ุงูุนูู ุงูุฌุฏูุฏุฉ

### ูุจู ุงูุฅุตูุงุญ (KV-based)
```
ุทูุจ 1 โ KV GET counter (5) โ +1 โ KV PUT (6) โ๏ธ ุชุถุงุฑุจ ูุญุชูู
ุทูุจ 2 โ KV GET counter (5) โ +1 โ KV PUT (6) โ๏ธ ููุณ ุงูุฑูู!
```

### ุจุนุฏ ุงูุฅุตูุงุญ (Durable Object)
```
ุทูุจ 1 โ DO instance โ ูุนุงูุฌุฉ ุชุณูุณููุฉ โ ุฑูู 6 โ
ุทูุจ 2 โ DO instance โ ุงูุชุธุงุฑ โ ูุนุงูุฌุฉ ุชุณูุณููุฉ โ ุฑูู 7 โ
```

ูู ุนูุงุฏุฉ ููุง **Durable Object instance** ุฎุงุต ุจูุงุ ูุถูู:
- ูุนุงูุฌุฉ ุฌููุน ุงูุทูุจุงุช ุจุงูุชุณูุณู
- ุนุฏู ูุฌูุฏ ุฃู ุชุถุงุฑุจ ุฃู ุชูุฑุงุฑ
- ููุซูููุฉ 100%

---

## ุงูุชูุงูููุฉ ูุน ุงูุฃูุธูุฉ ุงูููุฌูุฏุฉ

ุงูุฅุตูุงุญ ูุชูุงูู ุชูุงูุงู ูุน:
- โ ูุธุงู PIN (ูู ูุชุฃุซุฑ)
- โ ูุธุงู ุงููุณุงุฑุงุช ุงูุฏููุงููููุฉ (ูู ูุชุฃุซุฑ)
- โ ูุธุงู ุงูุฅุดุนุงุฑุงุช (ุชู ุชุญุณููู)
- โ ูุงุฌูุฉ ุงููุณุชุฎุฏู (ูุง ุชุบููุฑุงุช ูุทููุจุฉ)
- โ ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ (ูุง ุชุบููุฑุงุช ูุทููุจุฉ)

---

## ุงูุงุฎุชุจุงุฑ ูุงูุชุญูู

### ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุจุฉ ุจุนุฏ ุงููุดุฑ

1. **ุงุฎุชุจุงุฑ ุงูุชุฒุงูู:**
   ```bash
   # ุฅุฑุณุงู 5 ุทูุจุงุช ูุชุฒุงููุฉ
   for i in {1..5}; do
     curl -X POST https://www.mmc-mms.com/api/v1/queue/enter \
       -H "Content-Type: application/json" \
       -d "{\"clinic\":\"lab\",\"user\":\"TEST_$i\"}" &
   done
   wait
   ```
   **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** ุฃุฑูุงู ูุชุณูุณูุฉ ุจุฏูู ุชูุฑุงุฑ (30, 31, 32, 33, 34)

2. **ุงุฎุชุจุงุฑ SSE:**
   ```bash
   curl -N https://www.mmc-mms.com/api/v1/events/stream?clinic=lab
   ```
   **ุงููุชูุฌุฉ ุงููุชููุนุฉ:** 
   - ุฑุณุงูุฉ CONNECTED ููุฑูุฉ
   - heartbeat ูู 15 ุซุงููุฉ
   - ุชุญุฏูุซุงุช ุงูุฏูุฑ ูู 5 ุซูุงู

3. **ุงุฎุชุจุงุฑ ุงูุฃุฏุงุก:**
   - ูุญุงูุงุฉ 10+ ูุณุชุฎุฏููู ูุชุฒุงูููู
   - ุงูุชุญูู ูู ุนุฏู ูุฌูุฏ ุฃู ุชุฃุฎูุฑ ููุญูุธ
   - ุงูุชุญูู ูู ุฏูุฉ ุงูุฃุฑูุงู 100%

---

## ููุงุญุธุงุช ูููุฉ

### ูููุทูุฑูู
- ุงูู Durable Object ูููุดุฃ ุชููุงุฆูุงู ููู ุนูุงุฏุฉ ุนูุฏ ุฃูู ุทูุจ
- ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุนููู ูุฏููุฉุ ุงููุธุงู ูุฏูุฑ ุฐูู ุชููุงุฆูุงู
- ูููู ุฅุถุงูุฉ endpoint `/reset` ููุฅุนุงุฏุฉ ุงููุฏููุฉ ุฅุฐุง ูุฒู ุงูุฃูุฑ

### ููุฅุฏุงุฑุฉ
- ุงููุธุงู ุงูุขู ููุซูู 100% ุชุญุช ุฃู ุญูู
- ูุง ุญุงุฌุฉ ูุฅุฌุฑุงุกุงุช ุฅุถุงููุฉ ุฃู ูุฑุงูุจุฉ ุฎุงุตุฉ
- ุงูุฅุตูุงุญ ุดูุงู ุชูุงูุงู ูููุณุชุฎุฏููู ุงูููุงุฆููู

---

## ุงููุฑุงุฌุน

- [Cloudflare Durable Objects Documentation](https://developers.cloudflare.com/durable-objects/)
- [Cloudflare KV Eventual Consistency](https://developers.cloudflare.com/workers/runtime-apis/kv/#eventual-consistency)
- [Server-Sent Events (SSE) Best Practices](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events)

---

**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ูููุดุฑ
**ุงูุฃููููุฉ:** ๐ด ุญุฑุฌุฉ
**ุงูุชุฃุซูุฑ:** ููุซูููุฉ ุงููุธุงู 100%

