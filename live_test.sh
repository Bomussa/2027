#!/bin/bash
# ========================================
# Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
# ========================================
# Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-10-23
# Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³: Lead Software Architect
# ========================================

BASE_URL="http://localhost:8788"
REPORT_FILE="live_test_report.txt"
ERROR_LOG="live_test_errors.log"

# ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
> "$REPORT_FILE"
> "$ERROR_LOG"

echo "========================================="
echo "Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ"
echo "========================================="
echo ""

# Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
cat > "$REPORT_FILE" << 'EOF'
=================================================================
ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ
=================================================================
Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-10-23
Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³: Lead Software Architect
Ø§Ù„Ø¨ÙŠØ¦Ø©: Wrangler Pages Dev (localhost:8788)

=================================================================
EOF

PASS=0
FAIL=0

# Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
test_endpoint() {
    local name="$1"
    local method="$2"
    local endpoint="$3"
    local data="$4"
    local expected_status="$5"
    
    echo "Ø§Ø®ØªØ¨Ø§Ø±: $name"
    echo "" >> "$REPORT_FILE"
    echo "=== $name ===" >> "$REPORT_FILE"
    echo "Ø§Ù„Ù…Ø³Ø§Ø±: $method $endpoint" >> "$REPORT_FILE"
    
    if [ "$method" == "GET" ]; then
        response=$(curl -s -w "\n%{http_code}" "$BASE_URL$endpoint" 2>&1)
    else
        response=$(curl -s -w "\n%{http_code}" -X "$method" \
            -H "Content-Type: application/json" \
            -d "$data" \
            "$BASE_URL$endpoint" 2>&1)
    fi
    
    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
    status_code=$(echo "$response" | tail -n1)
    body=$(echo "$response" | head -n-1)
    
    echo "Ø§Ù„Ø­Ø§Ù„Ø©: $status_code" >> "$REPORT_FILE"
    echo "Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: $body" >> "$REPORT_FILE"
    
    if [ "$status_code" == "$expected_status" ]; then
        echo "   âœ… Ù†Ø¬Ø­ ($status_code)" | tee -a "$REPORT_FILE"
        ((PASS++))
        return 0
    else
        echo "   âŒ ÙØ´Ù„ (Ù…ØªÙˆÙ‚Ø¹: $expected_statusØŒ ÙØ¹Ù„ÙŠ: $status_code)" | tee -a "$REPORT_FILE"
        echo "[$name] ÙØ´Ù„ - Ù…ØªÙˆÙ‚Ø¹: $expected_statusØŒ ÙØ¹Ù„ÙŠ: $status_code" >> "$ERROR_LOG"
        echo "Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: $body" >> "$ERROR_LOG"
        echo "---" >> "$ERROR_LOG"
        ((FAIL++))
        return 1
    fi
}

echo "========================================="
echo "1. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"
echo "========================================="
echo ""

# 1. Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
test_endpoint "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" "GET" "/" "200"

# 2. Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Middleware)
test_endpoint "Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (MW)" "GET" "/mw/admin/pins/today" "200"

# 3. Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (API Ø§Ù„Ù‚Ø¯ÙŠÙ…)
test_endpoint "Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (API)" "GET" "/api/v1/pin/status" "200"

echo ""
echo "========================================="
echo "2. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù„Ø³Ø§Øª"
echo "========================================="
echo ""

# 4. Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø© (Middleware)
test_endpoint "Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© (MW)" "POST" "/mw/session/start" \
    '{"deviceId":"test123","sessionId":"sess_001"}' "200"

# 5. ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø±ÙŠØ¶ (API)
test_endpoint "ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø±ÙŠØ¶ (API)" "POST" "/api/v1/patient/login" \
    '{"patientId":"12345","gender":"male"}' "200"

echo ""
echo "========================================="
echo "3. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ±"
echo "========================================="
echo ""

# 6. Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ± ÙÙŠ Ø¹ÙŠØ§Ø¯Ø© (API)
test_endpoint "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙˆØ± (API)" "GET" "/api/v1/queue/status?clinic=general" "200"

# 7. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ± (API)
test_endpoint "Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯ÙˆØ± (API)" "POST" "/api/v1/queue/enter" \
    '{"clinic":"general","user":"12345","isAutoEntry":false}' "200"

echo ""
echo "========================================="
echo "4. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª"
echo "========================================="
echo ""

# 8. Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Middleware)
test_endpoint "Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (MW)" "POST" "/mw/notify/info" \
    '{"message":"test notification"}' "200"

# 9. Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (API)
test_endpoint "Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (API)" "GET" "/api/v1/notify/status" "200"

echo ""
echo "========================================="
echo "5. Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©"
echo "========================================="
echo ""

# 10. Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© (Middleware)
test_endpoint "Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (MW)" "GET" "/mw/admin/live" "200"

# 11. Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (API)
test_endpoint "Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (API)" "GET" "/api/v1/admin/status" "200"

# 12. Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Dashboard (API)
test_endpoint "Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Dashboard (API)" "GET" "/api/v1/stats/dashboard" "200"

echo ""
echo "========================================="
echo "6. Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸Ø§Ù… Ø§Ù„ØµØ­Ø©"
echo "========================================="
echo ""

# 13. Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­Ø© (API)
test_endpoint "Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­Ø© (API)" "GET" "/api/v1/health/status" "200"

echo ""
echo "========================================="
echo "Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©"
echo "========================================="
echo "âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©: $PASS"
echo "âŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ§Ø´Ù„Ø©: $FAIL"
TOTAL=$((PASS + FAIL))
if [ "$TOTAL" -gt 0 ]; then
    PERCENTAGE=$((PASS * 100 / TOTAL))
else
    PERCENTAGE=0
fi
echo "ðŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: $PERCENTAGE%"
echo ""

# ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
cat >> "$REPORT_FILE" << EOF

=================================================================
Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
=================================================================
âœ… Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©: $PASS
âŒ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ§Ø´Ù„Ø©: $FAIL
ðŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: $PERCENTAGE%

EOF

if [ "$FAIL" -eq 0 ]; then
    echo "ðŸŽ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø¬Ø­Øª Ø¨Ù†Ø³Ø¨Ø© 100%"
    echo "âœ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…"
    cat >> "$REPORT_FILE" << EOF
Ø§Ù„Ø­Ø§Ù„Ø©: âœ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù†Ø¬Ø­Øª Ø¨Ù†Ø³Ø¨Ø© 100%
Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©: âœ… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…

=================================================================
Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: Lead Software Architect
Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-10-23
Ø§Ù„Ø­Ø§Ù„Ø©: âœ… Ù…Ø¹ØªÙ…Ø¯ Ù„Ù„ØªØ³Ù„ÙŠÙ…
=================================================================
EOF
    exit 0
else
    echo "âš ï¸  ÙŠÙˆØ¬Ø¯ $FAIL Ø§Ø®ØªØ¨Ø§Ø± ÙØ§Ø´Ù„"
    echo "ðŸ“„ Ø±Ø§Ø¬Ø¹ Ù…Ù„Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: $ERROR_LOG"
    cat >> "$REPORT_FILE" << EOF
Ø§Ù„Ø­Ø§Ù„Ø©: âš ï¸ ÙŠÙˆØ¬Ø¯ $FAIL Ø§Ø®ØªØ¨Ø§Ø± ÙØ§Ø´Ù„
Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: Ø±Ø§Ø¬Ø¹ Ù…Ù„Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆÙ‚Ù… Ø¨Ø§Ù„Ø¥ØµÙ„Ø§Ø­

Ù…Ù„Ù Ø§Ù„Ø£Ø®Ø·Ø§Ø¡: $ERROR_LOG

=================================================================
Ø§Ù„ØªÙˆÙ‚ÙŠØ¹: Lead Software Architect
Ø§Ù„ØªØ§Ø±ÙŠØ®: 2025-10-23
Ø§Ù„Ø­Ø§Ù„Ø©: âš ï¸ ÙŠØªØ·Ù„Ø¨ Ø¥ØµÙ„Ø§Ø­
=================================================================
EOF
    exit 1
fi

